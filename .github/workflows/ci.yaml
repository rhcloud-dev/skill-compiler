name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.6.0
      - run: go build ./cmd/sc/
      - run: go test ./...
      - run: go vet ./...

  tag:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bump minor version and tag
        id: bump
        run: |
          LATEST=$(git tag --list 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)

          NEXT="v${MAJOR}.$((MINOR + 1)).0"

          echo "Latest tag: $LATEST"
          echo "Next tag: $NEXT"

          git tag "$NEXT"
          git push origin "$NEXT"
          echo "new_tag=$NEXT" >> "$GITHUB_OUTPUT"

  release:
    needs: tag
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.tag.outputs.new_tag }}
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ needs.tag.outputs.new_tag }}
