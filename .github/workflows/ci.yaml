name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - uses: golangci/golangci-lint-action@v7
        with:
          version: v2.6.0
      - run: go build ./cmd/sc/
      - run: go test ./...
      - run: go vet ./...

  tag:
    needs: build
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler'
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version bump from commits since last tag
        id: bump
        run: |
          LATEST=$(git tag --list 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST" ]; then
            LATEST="v0.0.0"
          fi

          # Non-releasable types â€” commits with these types OR scopes are skipped
          SKIP_RE='^(ci|chore|docs|style|test|build)(\(.+\))?:'
          SKIP_SCOPE_RE='^[[:alnum:]_]+\((ci|chore|docs|style|test|build)\)!?:'

          # Scan all commits since last tag, pick the highest bump level
          BUMP=""
          while IFS= read -r -d '' COMMIT; do
            MSG=${COMMIT%%$'\n'*}
            if [[ "$COMMIT" == *$'\n'* ]]; then
              BODY=${COMMIT#*$'\n'}
            else
              BODY=""
            fi
            # Skip non-releasable types and scopes (e.g. fix(ci): is a CI change)
            if echo "$MSG" | grep -qE "$SKIP_RE" || echo "$MSG" | grep -qE "$SKIP_SCOPE_RE"; then
              continue
            fi
            if echo "$MSG" | grep -qE '^.+!:' || echo "$BODY" | grep -qE '^BREAKING[ -]CHANGE:'; then
              BUMP="major"
              break  # Can't go higher
            elif echo "$MSG" | grep -qE '^feat(\(.+\))?:'; then
              [ "$BUMP" != "major" ] && BUMP="minor"
            elif echo "$MSG" | grep -qE '^(fix|perf|refactor)(\(.+\))?:'; then
              [ -z "$BUMP" ] && BUMP="patch"
            fi
          done < <(git log "${LATEST}..HEAD" --format='%s%n%b%x00')

          if [ -z "$BUMP" ]; then
            echo "No releasable commits since $LATEST"
            exit 0
          fi

          MAJOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f1)
          MINOR=$(echo "$LATEST" | sed 's/v//' | cut -d. -f2)
          PATCH=$(echo "$LATEST" | sed 's/v//' | cut -d. -f3)

          case "$BUMP" in
            major) NEXT="v$((MAJOR + 1)).0.0" ;;
            minor) NEXT="v${MAJOR}.$((MINOR + 1)).0" ;;
            patch) NEXT="v${MAJOR}.${MINOR}.$((PATCH + 1))" ;;
          esac

          echo "Latest tag: $LATEST"
          echo "Bump type: $BUMP"
          echo "Next tag: $NEXT"

          git tag "$NEXT"
          git push origin "$NEXT"
          echo "new_tag=$NEXT" >> "$GITHUB_OUTPUT"

  release:
    needs: tag
    if: github.ref == 'refs/heads/main' && github.repository == 'rhcloud-dev/skill-compiler' && needs.tag.outputs.new_tag != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.tag.outputs.new_tag }}
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25.3"
      - name: Generate release notes
        run: |
          TAG="${{ needs.tag.outputs.new_tag }}"
          VER="${TAG#v}"

          # Try CHANGELOG.md first
          awk "/^## \\[v${VER}\\]/{found=1; next} /^## \\[v/{if(found) exit} found" CHANGELOG.md > /tmp/release-notes.md 2>/dev/null || true

          # Fall back to git log if no changelog entry
          if [ ! -s /tmp/release-notes.md ]; then
            PREV=""
            # Use git describe to find the previous tag reachable before the current tag
            if git rev-parse "${TAG}^" >/dev/null 2>&1; then
              PREV=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "")
            fi

            if [ -n "$PREV" ] && [ "$PREV" != "$TAG" ]; then
              echo "## What's Changed" > /tmp/release-notes.md
              git log "${PREV}..${TAG}" --format='- %s' >> /tmp/release-notes.md
            else
              echo "Release ${TAG}" > /tmp/release-notes.md
            fi
          fi
      - uses: goreleaser/goreleaser-action@v7
        with:
          version: latest
          args: release --clean --release-notes=/tmp/release-notes.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ needs.tag.outputs.new_tag }}
